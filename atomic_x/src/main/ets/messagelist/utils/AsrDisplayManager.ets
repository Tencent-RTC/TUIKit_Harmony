/**
 * ASR Display Manager
 * Manages the display state of ASR (Automatic Speech Recognition) text bubbles.
 *
 * Kotlin/Compose å¯¹é½ç­–ç•¥ï¼š
 * - **é»˜è®¤å±•ç¤º**ï¼šå½“æ¶ˆæ¯å·²æœ‰ asrText æ—¶ï¼Œè¿›å…¥æ¶ˆæ¯åˆ—è¡¨é»˜è®¤å±•ç¤º ASR æ°”æ³¡
 * - **ä¼šè¯å†…å¯éšè—**ï¼šç”¨æˆ·åœ¨å½“å‰ä¼šè¯ä¸­ç‚¹â€œéšè—â€åï¼Œæœ¬æ¬¡ä¼šè¯å†…ä¸å†å±•ç¤º
 * - **éæŒä¹…åŒ–**ï¼šé€€å‡ºæ¶ˆæ¯åˆ—è¡¨åå®ä¾‹é”€æ¯ï¼Œéšè—çŠ¶æ€ä¸¢å¤±
 *
 * å®ç°æ–¹å¼ï¼šä½¿ç”¨â€œhidden setâ€æ¨¡å¼ã€‚
 * - `isExpanded(messageID)` å®é™…å«ä¹‰ä¸ºâ€œæœªè¢«éšè—â€ï¼Œç”¨äºå…¼å®¹æ—¢æœ‰è°ƒç”¨ç‚¹
 */
@Observed
export class AsrDisplayManager {
  // Stores message IDs that have been hidden (collapsed) in this session
  private hiddenMessageIDs: Set<string> = new Set();
  // Stores message IDs that are currently converting
  private convertingMessageIDs: Set<string> = new Set();
  // Listeners for state changes
  private listeners: Set<() => void> = new Set();
  // Version counter to trigger UI updates (ArkTS can detect primitive changes)
  public version: number = 0;

  constructor() {}

  /**
   * Check if ASR bubble should be considered expanded (i.e., not hidden) for a message.
   * Note: actual rendering should still depend on whether asrText exists.
   */
  isExpanded(messageID: string | undefined): boolean {
    if (!messageID || messageID.length === 0) {
      return false;
    }
    return !this.hiddenMessageIDs.has(messageID);
  }

  /**
   * Expand (show) ASR bubble for a message in this session.
   * With hidden-set semantics, this means removing from hidden set.
   */
  expand(messageID: string | undefined): void {
    if (!messageID || messageID.length === 0) {
      return;
    }
    if (this.hiddenMessageIDs.has(messageID)) {
      this.hiddenMessageIDs.delete(messageID);
      this.version++; // Trigger UI update
      console.log(`[AsrDisplayManager] ğŸ‘ï¸ Show ASR bubble for message: ${messageID}, version: ${this.version}`);
      this.notifyListeners();
    }
  }

  /**
   * Collapse (hide) ASR bubble for a message in this session.
   * With hidden-set semantics, this means adding to hidden set.
   */
  collapse(messageID: string | undefined): void {
    if (!messageID || messageID.length === 0) {
      return;
    }
    if (!this.hiddenMessageIDs.has(messageID)) {
      this.hiddenMessageIDs.add(messageID);
      this.version++; // Trigger UI update
      console.log(`[AsrDisplayManager] ğŸ™ˆ Hide ASR bubble for message: ${messageID}, version: ${this.version}`);
      this.notifyListeners();
    }
  }

  /**
   * Check if a message is currently being converted
   */
  isConverting(messageID: string | undefined): boolean {
    if (!messageID || messageID.length === 0) {
      return false;
    }
    return this.convertingMessageIDs.has(messageID);
  }

  /**
   * Set the converting state for a message.
   * When starting conversion, always unhide the bubble so loading state can be shown.
   */
  setConverting(messageID: string | undefined, converting: boolean): void {
    if (!messageID || messageID.length === 0) {
      return;
    }

    let changed = false;

    if (converting) {
      if (!this.convertingMessageIDs.has(messageID)) {
        this.convertingMessageIDs.add(messageID);
        changed = true;
      }
      // Ensure bubble is visible when converting
      if (this.hiddenMessageIDs.has(messageID)) {
        this.hiddenMessageIDs.delete(messageID);
        changed = true;
      }

      if (changed) {
        this.version++; // Trigger UI update
        console.log(`[AsrDisplayManager] â³ Started converting message: ${messageID}, version: ${this.version}`);
        this.notifyListeners();
      }
    } else {
      if (this.convertingMessageIDs.has(messageID)) {
        this.convertingMessageIDs.delete(messageID);
        changed = true;
      }

      if (changed) {
        this.version++; // Trigger UI update
        console.log(`[AsrDisplayManager] âœ… Finished converting message: ${messageID}, version: ${this.version}`);
        this.notifyListeners();
      }
    }
  }

  /**
   * Clear all hidden and converting states
   */
  clear(): void {
    if (this.hiddenMessageIDs.size > 0 || this.convertingMessageIDs.size > 0) {
      this.hiddenMessageIDs.clear();
      this.convertingMessageIDs.clear();
      this.version++; // Trigger UI update
      console.log(`[AsrDisplayManager] ğŸ—‘ï¸ Cleared all states, version: ${this.version}`);
      this.notifyListeners();
    }
  }

  /**
   * Add a listener for state changes
   */
  addListener(callback: () => void): void {
    this.listeners.add(callback);
  }

  /**
   * Remove a listener
   */
  removeListener(callback: () => void): void {
    this.listeners.delete(callback);
  }

  /**
   * Notify all listeners of state change
   */
  private notifyListeners(): void {
    console.log(`[AsrDisplayManager] ğŸ“¢ Notifying ${this.listeners.size} listeners`);
    this.listeners.forEach((callback) => {
      try {
        callback();
      } catch (error) {
        console.error(`[AsrDisplayManager] âŒ Listener callback error:`, error);
      }
    });
  }
}
